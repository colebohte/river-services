<!DOCTYPE html>
<html>
<head>
  <title>Supabase Auth Login</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Basic styling to show loading or status */
    body { font-family: sans-serif; text-align: center; padding-top: 50px; }
  </style>
</head>
<body>
  <p>Attempting to log in...</p>
  <div id="status"></div>

  <script>
    // !!! IMPORTANT: Replace with your actual Supabase project URL and anon key !!!
    const SUPABASE_URL = 'https://gxqbrcutslyybxexvszr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4cWJyY3V0c2x5eWJ4ZXh2c3pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NTMxODYsImV4cCI6MjA2MjMyOTE4Nn0.yBF90TTgVBVihO5rH0HpK4DvKFfy4fGm3ps05vKeDjU';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function handleAuthCallback() {
      const { data, error } = await supabase.auth.getSession();

      if (error) {
        console.error('Supabase auth error:', error);
        document.getElementById('status').innerText = 'Login failed: ' + error.message;
        // Optionally send error back to opener
        if (window.opener) {
            // !!! IMPORTANT: Replace '*' with the specific origin of your Scratch environment (e.g., 'https://turbowarp.org') in production !!!
            window.opener.postMessage({ type: 'supabaseAuthResult', success: false, error: error.message }, '*');
        }
        // Do not close on error immediately, allow user to see message
      } else if (data.session) {
        console.log('Supabase session received:', data.session);
        document.getElementById('status').innerText = 'Login successful. Returning to Scratch...';
        // Send user data back to the window that opened this one
        if (window.opener) {
          const user = data.session.user;
          const userData = {
            type: 'supabaseAuthResult',
            success: true,
            user: {
              id: user.id,
              email: user.email,
              full_name: user.user_metadata.full_name || '', // Assuming Google provides full_name
              avatar_url: user.user_metadata.avatar_url || '', // Assuming Google provides avatar_url
              email_verified: user.email_verified || false, // Assuming Google provides email_verified
              // Add other metadata you might need
            }
          };
          // !!! IMPORTANT: Replace '*' with the specific origin of your Scratch environment (e.g., 'https://turbowarp.org') in production !!!
          window.opener.postMessage(userData, '*');
          // Close this window after a short delay
          setTimeout(() => window.close(), 1000);
        } else {
             document.getElementById('status').innerText = 'Login successful, but could not communicate back to Scratch (window.opener not found).';
        }
      } else {
         // This might happen on initial load before redirect or if no session is found
         document.getElementById('status').innerText = 'No active session found or session data is incomplete. Redirecting to login...';
         // Initiate the login redirect if no session
         initiateLogin();
      }
    }

    async function initiateLogin() {
         // !!! IMPORTANT: Replace with the exact URL where this login.html file is hosted on GitHub Pages !!!
         const redirectUrl = 'https://colebohte.github.io/river-services/login.html';

         const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
                // Specify the redirect URI where Supabase should send the user back
                // This must match a URI configured in your Supabase Auth settings
                redirectTo: redirectUrl
            }
         });
         if (error) {
             console.error('Error initiating OAuth:', error);
             document.getElementById('status').innerText = 'Error initiating login: ' + error.message;
             if (window.opener) {
                 // !!! IMPORTANT: Replace '*' with the specific origin of your Scratch environment (e.g., 'https://turbowarp.org') in production !!!
                 window.opener.postMessage({ type: 'supabaseAuthResult', success: false, error: error.message }, '*');
             }
         }
         // Note: signInWithOAuth redirects the user, so code after this won't run immediately
    }

    // When the page loads, check if a session exists (happens after Google redirects back to this page)
    // If no session exists, initiate the login flow by redirecting to Google.
    supabase.auth.getSession().then(({ data }) => {
        if (data.session) {
            // If a session is found (meaning we were redirected back here after login)
            handleAuthCallback();
        } else {
            // No session found, meaning the user clicked the login block and landed here initially
            console.log("No session found, initiating login redirect.");
            initiateLogin();
        }
    }).catch(err => {
         console.error('Error checking initial session:', err);
         document.getElementById('status').innerText = 'Error checking initial session.';
          if (window.opener) {
              // !!! IMPORTANT: Replace '*' with the specific origin of your Scratch environment (e.g., 'https://turbowarp.org') in production !!!
             window.opener.postMessage({ type: 'supabaseAuthResult', success: false, error: err.message }, '*');
         }
    });


  </script>
</body>
</html>
