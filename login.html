<!DOCTYPE html>
<html>
<head>
  <title>Supabase Auth Login</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Basic styling to show loading or status */
    body { font-family: sans-serif; text-align: center; padding-top: 50px; }
  </style>
</head>
<body>
  <p>Attempting to log in...</p>
  <div id="status"></div>

  <script>
    // Replace with your Supabase project URL and anon key
    const SUPABASE_URL = 'https://gxqbrcutslyybxexvszr.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd4cWJyY3V0c2x5eWJ4ZXh2c3pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NTMxODYsImV4cCI6MjA2MjMyOTE4Nn0.yBF90TTgVBVihO5rH0HpK4DvKFfy4fGm3ps05vKeDjU';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function handleAuthCallback() {
      const { data, error } = await supabase.auth.getSession();

      if (error) {
        console.error('Supabase auth error:', error);
        document.getElementById('status').innerText = 'Login failed.';
        // Optionally send error back to opener
        if (window.opener) {
            window.opener.postMessage({ type: 'supabaseAuthResult', success: false, error: error.message }, '*'); // Use a specific origin in production!
        }
      } else if (data.session) {
        console.log('Supabase session received:', data.session);
        document.getElementById('status').innerText = 'Login successful. Returning to Scratch...';
        // Send user data back to the window that opened this one
        if (window.opener) {
          const user = data.session.user;
          const userData = {
            type: 'supabaseAuthResult',
            success: true,
            user: {
              id: user.id,
              email: user.email,
              full_name: user.user_metadata.full_name || '', // Assuming Google provides full_name
              avatar_url: user.user_metadata.avatar_url || '', // Assuming Google provides avatar_url
              email_verified: user.email_verified || false, // Assuming Google provides email_verified
              // Add other metadata you might need
            }
          };
          window.opener.postMessage(userData, '*'); // Use a specific origin in production!
          // Close this window after a short delay
          setTimeout(() => window.close(), 1000);
        } else {
             document.getElementById('status').innerText = 'Login successful, but could not communicate back to Scratch.';
        }
      } else {
         // This might happen on initial load before redirect or if no session is found
         document.getElementById('status').innerText = 'No active session found. Redirecting to login...';
         // Initiate the login redirect if no session
         initiateLogin();
      }
    }

    async function initiateLogin() {
         const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
                // Specify the redirect URI where Supabase should send the user back
                // This should match a URI configured in your Supabase Auth settings
                redirectTo: window.location.href // Redirect back to this same page to handle the session
            }
         });
         if (error) {
             console.error('Error initiating OAuth:', error);
             document.getElementById('status').innerText = 'Error initiating login.';
             if (window.opener) {
                 window.opener.postMessage({ type: 'supabaseAuthResult', success: false, error: error.message }, '*'); // Use a specific origin!
             }
         }
    }

    // Check for session immediately when the page loads (in case of redirect)
    // If no session, initiate the login flow.
    supabase.auth.getSession().then(({ data }) => {
        if (data.session) {
            handleAuthCallback(); // Session found, process it
        } else {
            initiateLogin(); // No session, start login
        }
    }).catch(err => {
         console.error('Error checking session:', err);
         document.getElementById('status').innerText = 'Error checking session.';
          if (window.opener) {
             window.opener.postMessage({ type: 'supabaseAuthResult', success: false, error: err.message }, '*'); // Use a specific origin!
         }
    });


  </script>
</body>
</html>
