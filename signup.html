<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Create a River Account</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
      /* Basic styling for Inter font and messages */
      body {
          font-family: 'Inter', sans-serif;
      }
      .message.success {
          background-color: #d1fae5;
          color: #065f46;
          border: 1px solid #34d399;
      }
      .message.error {
          background-color: #fee2e2;
          color: #991b1b;
          border: 1px solid #ef4444;
      }
      .hidden {
          display: none;
      }
  </style>
</head>
<body class="bg-gray-100 flex items-center justify-center h-screen">
  <div class="bg-white p-8 rounded shadow-md w-full max-w-sm">
    <h1 class="text-2xl font-bold mb-6 text-center">Sign Up</h1>
    <form id="signup-form" class="space-y-4">
      <input
        type="text"
        id="email"
        placeholder="Email or Phone Number"
        class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        required
      />
      <div id="input-type-indicator" class="text-xs text-gray-500 mt-1 hidden"></div>
      <input
        type="text"
        id="username"
        placeholder="Username (max 32 chars, no spaces/caps/special chars)"
        class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        maxlength="32"
        required
      />
      <input
        type="password"
        id="password"
        placeholder="Password"
        class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        required
      />
      <input
        type="password"
        id="confirm-password"
        placeholder="Confirm Password"
        class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        required
      />
      <button
        type="submit"
        id="signup-button"
        class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600 transition-colors"
      >
        Sign Up
      </button>
    </form>
    <p class="text-sm text-gray-600 mt-4">
        Have an account?
        <a href="/river-services/signin.html" class="text-indigo-600 hover:text-indigo-800 underline">Sign In</a>
    </p>
    <div id="message-area" class="mt-4 p-3 rounded-lg text-sm text-left hidden"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    // âœ… Make sure your keys are actually correct here
    const supabaseUrl = 'https://lmewabaqrhkxvpydrjjh.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtZXdhYmFxcmhreHZweWRyampoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgzOTY4MzAsImV4cCI6MjA2Mzk3MjgzMH0.8ClAfvkOqELoBa2lx-ylhStEJjg8KFVlA3IhF5CdSXE'
    const supabase = createClient(supabaseUrl, supabaseKey)

    // Get DOM elements
    const form = document.getElementById('signup-form')
    const emailInput = document.getElementById('email')
    const usernameInput = document.getElementById('username')
    const passwordInput = document.getElementById('password')
    const confirmPasswordInput = document.getElementById('confirm-password')
    const signupButton = document.getElementById('signup-button')
    const messageArea = document.getElementById('message-area')
    const inputTypeIndicator = document.getElementById('input-type-indicator')

    /**
     * Detects if the input looks like a phone number
     * @param {string} input - The input string to check
     * @returns {boolean} - True if it looks like a phone number
     */
    function isPhoneNumber(input) {
        // Remove all non-digit characters
        const digitsOnly = input.replace(/\D/g, '');
        
        // Check if it's a reasonable phone number length (7-15 digits)
        // and doesn't contain @ symbol (email indicator)
        return digitsOnly.length >= 7 && 
               digitsOnly.length <= 15 && 
               !input.includes('@') &&
               (input.includes('-') || input.includes('(') || input.includes(')') || 
                input.includes(' ') || input.includes('+') || /^\d+$/.test(input.trim()));
    }

    /**
     * Formats a phone number to E.164 format
     * @param {string} phone - The phone number to format
     * @returns {string} - Formatted phone number
     */
    function formatPhoneNumber(phone) {
        // Remove all non-digit characters
        let digitsOnly = phone.replace(/\D/g, '');
        
        // If it starts with 1 and is 11 digits (US/Canada), keep as is
        if (digitsOnly.length === 11 && digitsOnly.startsWith('1')) {
            return '+' + digitsOnly;
        }
        // If it's 10 digits, assume US/Canada and add +1
        else if (digitsOnly.length === 10) {
            return '+1' + digitsOnly;
        }
        // Otherwise, assume it already has country code or add +1
        else if (digitsOnly.length >= 7) {
            return digitsOnly.startsWith('+') ? phone : '+' + digitsOnly;
        }
        
        return phone; // Return as-is if we can't format it
    }

    /**
     * Updates the input type indicator
     * @param {string} type - 'email' or 'phone'
     */
    function updateInputIndicator(type) {
        if (type === 'phone') {
            inputTypeIndicator.textContent = 'ðŸ“± Detected phone number - we\'ll send you a text confirmation';
            inputTypeIndicator.classList.remove('hidden');
        } else if (type === 'email') {
            inputTypeIndicator.textContent = 'ðŸ“§ Detected email - we\'ll send you an email confirmation';
            inputTypeIndicator.classList.remove('hidden');
        } else {
            inputTypeIndicator.classList.add('hidden');
        }
    }

    // Add input listener to detect phone vs email
    emailInput.addEventListener('input', (e) => {
        const value = e.target.value.trim();
        if (value.length > 0) {
            if (isPhoneNumber(value)) {
                updateInputIndicator('phone');
            } else if (value.includes('@')) {
                updateInputIndicator('email');
            } else {
                inputTypeIndicator.classList.add('hidden');
            }
        } else {
            inputTypeIndicator.classList.add('hidden');
        }
    });

    /**
     * Displays a message to the user in the message area.
     * @param {string} text - The message text.
     * @param {'success' | 'error'} type - The type of message (determines styling).
     */
    function showMessage(text, type) {
        console.log(`${type.toUpperCase()}: ${text}`);
        messageArea.textContent = text;
        messageArea.className = `mt-4 p-3 rounded-lg text-sm text-left message ${type}`;
        messageArea.classList.remove('hidden');

        setTimeout(() => {
            messageArea.classList.add('hidden');
        }, 5000);
    }

    /**
     * Sets the loading state for the signup button.
     * @param {boolean} loading - True to show loading state, false otherwise.
     */
    function setButtonLoading(loading) {
        signupButton.disabled = loading;
        signupButton.textContent = loading ? 'Signing Up...' : 'Sign Up';
    }

    // Handle form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault()
      setButtonLoading(true); // Set button to loading state

      const emailOrPhone = emailInput.value.trim()
      const username = usernameInput.value.trim()
      const password = passwordInput.value
      const confirmPassword = confirmPasswordInput.value

      // Detect if input is phone or email
      const isPhone = isPhoneNumber(emailOrPhone)
      
      // --- Validation Checks ---
      if (password !== confirmPassword) {
        showMessage('Passwords do not match.', 'error');
        setButtonLoading(false);
        return;
      }

      if (emailOrPhone.length === 0) {
        showMessage('Email or phone number cannot be empty.', 'error');
        setButtonLoading(false);
        return;
      }

      // Validate phone number format if it's a phone
      if (isPhone) {
        const digitsOnly = emailOrPhone.replace(/\D/g, '');
        if (digitsOnly.length < 7 || digitsOnly.length > 15) {
          showMessage('Please enter a valid phone number.', 'error');
          setButtonLoading(false);
          return;
        }
      }

      // Validate email format if it's an email
      if (!isPhone && !emailOrPhone.includes('@')) {
        showMessage('Please enter a valid email address.', 'error');
        setButtonLoading(false);
        return;
      }

      if (username.length === 0) {
        showMessage('Username cannot be empty.', 'error');
        setButtonLoading(false);
        return;
      }

      if (username.length > 32) {
        showMessage('Username cannot exceed 32 characters.', 'error');
        setButtonLoading(false);
        return;
      }

      if (username.includes(' ')) {
        showMessage('Username cannot contain spaces.', 'error');
        setButtonLoading(false);
        return;
      }

      if (username !== username.toLowerCase()) {
        showMessage('Username cannot contain capital letters.', 'error');
        setButtonLoading(false);
        return;
      }

      // New validation: Check for special characters
      const alphanumericRegex = /^[a-z0-9]+$/; // Only lowercase letters and numbers
      if (!alphanumericRegex.test(username)) {
        showMessage('Username can only contain lowercase letters and numbers (no special characters).', 'error');
        setButtonLoading(false);
        return;
      }
      // --- End Validation Checks ---

      try {
        let signupOptions = {
          options: {
            data: {
              username: username,
              display_name: username
            }
          }
        };

        // Use different signup method based on input type
        if (isPhone) {
          const formattedPhone = formatPhoneNumber(emailOrPhone);
          signupOptions.phone = formattedPhone;
          signupOptions.password = password;
          
          const { error } = await supabase.auth.signUp(signupOptions);
          
          if (error) {
            console.error('Phone signup error:', error.message);
            showMessage(error.message, 'error');
          } else {
            showMessage('Sign up successful! Check your phone for a verification code.', 'success');
            // Clear form fields after successful signup
            emailInput.value = '';
            usernameInput.value = '';
            passwordInput.value = '';
            confirmPasswordInput.value = '';
            inputTypeIndicator.classList.add('hidden');
          }
        } else {
          // Email signup
          signupOptions.email = emailOrPhone;
          signupOptions.password = password;
          
          const { error } = await supabase.auth.signUp(signupOptions);
          
          if (error) {
            console.error('Email signup error:', error.message);
            showMessage(error.message, 'error');
          } else {
            showMessage('Sign up successful! Check your email and click the confirmation link. Make sure to check spam folder too!', 'success');
            // Clear form fields after successful signup
            emailInput.value = '';
            usernameInput.value = '';
            passwordInput.value = '';
            confirmPasswordInput.value = '';
            inputTypeIndicator.classList.add('hidden');
          }
        }
      } catch (err) {
          console.error('An unexpected error occurred during sign up:', err);
          showMessage('An unexpected error occurred during sign up.', 'error');
      } finally {
          setButtonLoading(false); // Reset button state
      }
    })
  </script>
</body>
</html>
