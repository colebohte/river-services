<!DOCTYPE html>
<html>
<head>
  <title>Supabase Auth Login</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* Basic styling to show loading or status */
    body { font-family: sans-serif; text-align: center; padding-top: 50px; }
    #status { margin-top: 20px; color: #333; }
  </style>
</head>
<body>
  <p>Attempting to log in...</p>
  <div id="status"></div>

  <script>
    // !!! IMPORTANT: Replace with your actual Supabase project URL and anon key !!!
    const SUPABASE_URL = 'YOUR_SUPABASE_URL';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';

    // Create the Supabase client instance
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Function to handle the authentication callback after redirect
    async function handleAuthCallback() {
      console.log("Handling auth callback...");
      // Get the session data from the URL or local storage after redirect
      const { data, error } = await supabase.auth.getSession();

      if (error) {
        console.error('Supabase auth error:', error);
        document.getElementById('status').innerText = 'Login failed: ' + error.message;
        // Send error message back to the window that opened this one (the Scratch environment)
        if (window.opener) {
            // !!! IMPORTANT: Replace '*' with the specific origin of your Scratch environment (e.g., 'https://turbowarp.org') in production !!!
            window.opener.postMessage({ type: 'supabaseAuthResult', success: false, error: error.message }, '*');
        }
        // Do not close on error immediately, allow user to see the error message
      } else if (data.session && data.session.user) {
        console.log('Supabase session received:', data.session);
        document.getElementById('status').innerText = 'Login successful. Returning to Scratch...';
        // Send user data back to the window that opened this one (the Scratch environment)
        if (window.opener) {
          const user = data.session.user;
          // Structure the user data to send back to the extension
          const userData = {
            type: 'supabaseAuthResult', // Identifier for the message type
            success: true,
            user: {
              id: user.id,
              email: user.email,
              full_name: user.user_metadata.full_name || '', // Assuming Google provides full_name in metadata
              avatar_url: user.user_metadata.avatar_url || '', // Assuming Google provides avatar_url in metadata
              email_verified: user.email_verified || false, // Assuming Google provides email_verified
              locale: user.user_metadata.locale || '', // Assuming locale might be in metadata (often not)
              // Add other metadata you might need from user.user_metadata
            }
          };
          // !!! IMPORTANT: Replace '*' with the specific origin of your Scratch environment (e.g., 'https://turbowarp.org') in production !!!
          window.opener.postMessage(userData, '*');
          // Close this window after a short delay to allow the message to be processed
          setTimeout(() => window.close(), 1000);
        } else {
             document.getElementById('status').innerText = 'Login successful, but could not communicate back to Scratch (window.opener not found).';
        }
      } else {
         // This might happen on initial load before redirect or if session data is incomplete
         console.log("No active session found or session data incomplete after callback.");
         document.getElementById('status').innerText = 'No active session found or data incomplete. Redirecting to login...';
         // If no session is found after the callback, it means the initial redirect didn't happen yet
         initiateLogin(); // Initiate the login redirect flow
      }
    }

    // Function to initiate the Google OAuth login redirect
    async function initiateLogin() {
         // !!! IMPORTANT: Replace with the exact URL where this login.html file is hosted on GitHub Pages !!!
         const redirectUrl = 'https://colebohte.github.io/river-services/login.html';
         console.log("Initiating login redirect to Google via Supabase...");

         const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
            options: {
                // Specify the redirect URI where Supabase should send the user back AFTER Google authentication.
                // This MUST match a URI configured in your Supabase Auth settings for the Google provider.
                redirectTo: redirectUrl,
                // You can request specific scopes if needed, though 'email' and 'profile' are often default
                // scopes: 'email profile'
            }
         });
         if (error) {
             console.error('Error initiating OAuth:', error);
             document.getElementById('status').innerText = 'Error initiating login: ' + error.message;
             if (window.opener) {
                 // !!! IMPORTANT: Replace '*' with the specific origin of your Scratch environment (e.g., 'https://turbowarp.org') in production !!!
                 window.opener.postMessage({ type: 'supabaseAuthResult', success: false, error: error.message }, '*');
             }
         }
         // Note: signInWithOAuth redirects the user's browser away from this page,
         // so code after this line will not execute immediately.
    }

    // When the page loads, first check if a session already exists.
    // This happens if the user was redirected back to this page after successfully logging in with Google.
    // If no session is found, it means the user just opened this page by clicking the Scratch block,
    // and we need to initiate the login redirect to Google.
    supabase.auth.getSession().then(({ data }) => {
        if (data.session && data.session.user) {
            // If a session is found (meaning we were redirected back here after login)
            console.log("Initial session found on page load.");
            handleAuthCallback(); // Process the session and send data back
        } else {
            // No session found, meaning the user just opened this page.
            console.log("No initial session found on page load. Initiating login.");
            initiateLogin(); // Start the OAuth flow by redirecting to Google
        }
    }).catch(err => {
         console.error('Error checking initial session on page load:', err);
         document.getElementById('status').innerText = 'Error checking initial session.';
          if (window.opener) {
              // !!! IMPORTANT: Replace '*' with the specific origin of your Scratch environment (e.g., 'https://turbowarp.org') in production !!!
             window.opener.postMessage({ type: 'supabaseAuthResult', success: false, error: err.message }, '*');
         }
    });


  </script>
</body>
</html>
